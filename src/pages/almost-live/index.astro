---
// layout
import BaseLayout from "@layouts/BaseLayout.astro";

// components
import CtaCardSplit from "@components/Cta/CtaCardSplit.astro";
---

<BaseLayout
	title="Almost Live! - Foundations"
	description="Almost Live! video content from Foundations"
>
	<section class="site-container space-y-12">
		<div
			class="overflow-x-clip bg-[url('/assets/pattern-light.svg')] bg-center bg-no-repeat pt-24 md:pt-32 dark:bg-none"
		>
			<div class="mx-auto flex max-w-[950px] flex-col items-center justify-center">
				<img 
					src="/assets/almost-live-logo.png" 
					alt="Almost Live! Logo" 
					class="h-32 w-auto md:h-48"
				/>
				<p class="mt-4 text-center text-lg text-muted-foreground">
					The voice of the Seattle startup community.
				</p>
			</div>
		</div>

		<!-- Loading state -->
		<div id="videos-loading" class="mx-auto max-w-4xl text-center">
			<div class="rounded-lg bg-gray-50 p-8 dark:bg-gray-800/50">
				<div class="mx-auto mb-4 h-12 w-12 animate-spin rounded-full border-4 border-gray-300 border-t-primary-600"></div>
				<p class="text-lg text-gray-600 dark:text-gray-300">Loading videos...</p>
			</div>
		</div>

		<!-- Error state (hidden by default) -->
		<div id="videos-error" class="mx-auto max-w-4xl text-center hidden">
			<div class="rounded-lg bg-red-50 p-8 dark:bg-red-900/20">
				<p class="text-lg text-red-800 dark:text-red-300">Failed to load videos</p>
				<p class="mt-2 text-sm text-red-600 dark:text-red-400">Please try again later.</p>
			</div>
		</div>

		<!-- Empty state (hidden by default) -->
		<div id="videos-empty" class="mx-auto max-w-4xl text-center hidden">
			<div class="rounded-lg bg-gray-50 p-8 dark:bg-gray-800/50">
				<p class="text-lg text-gray-600 dark:text-gray-300">No videos to display yet. Check back soon!</p>
			</div>
		</div>

		<!-- Videos container (hidden by default) -->
		<div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
			<div id="videos-container" class="space-y-12 hidden"></div>
			
			<!-- Pagination -->
			<div id="pagination-container" class="mt-12 flex items-center justify-center gap-4 hidden">
				<button 
					id="prev-page" 
					class="rounded-lg bg-gray-100 px-4 py-2 text-gray-700 transition hover:bg-gray-200 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
					disabled
				>
					← Previous
				</button>
				<span id="page-info" class="text-gray-600 dark:text-gray-400">Page 1 of 1</span>
				<button 
					id="next-page" 
					class="rounded-lg bg-gray-100 px-4 py-2 text-gray-700 transition hover:bg-gray-200 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
					disabled
				>
					Next →
				</button>
			</div>
		</div>
	</section>

	<CtaCardSplit />
</BaseLayout>

<script>
	interface Video {
		id: string;
		title: string;
		description: string;
		youtubeVideoId: string;
		embedUrl: string;
		watchUrl: string;
		thumbnailUrl: string;
		duration: string | null;
		formattedDuration: string;
		publishedAt: string;
		displayOrder: number;
	}

	interface VideosApiResponse {
		success: boolean;
		videos?: Video[];
	}

	const VIDEOS_PER_PAGE = 10;
	let allVideos: Video[] = [];
	let currentPage = 1;

	// Mock data for local development
	const mockData: VideosApiResponse = {
		success: true,
		videos: [
			{
				id: "98cf7509-bb07-4dc9-ac51-ed48b4d84ff3",
				title: "Welcome to Almost Live!",
				description: "Almost Live! is well... live! Learn what we're all about in this first installment!",
				youtubeVideoId: "8ZOytEC4suQ",
				embedUrl: "https://www.youtube.com/embed/8ZOytEC4suQ",
				watchUrl: "https://www.youtube.com/watch?v=8ZOytEC4suQ",
				thumbnailUrl: "https://img.youtube.com/vi/8ZOytEC4suQ/maxresdefault.jpg",
				duration: null,
				formattedDuration: "",
				publishedAt: "2026-01-13T00:00:00.000Z",
				displayOrder: 2
			},
			{
				id: "924dc99a-3006-4901-8a44-283e3fb4ca91",
				title: "Seattle: The Next Generation",
				description: 'Only builders can change the world. Our mission at Foundations is to make Seattle a better place to be a founder and encourage those builders to do that here. Our success begins and ends with empowering a strong next generation of founders. For the region to win, we need folks like <a href="https://www.linkedin.com/in/caleb-john-165675139/" target="_blank" rel="noopener noreferrer">Caleb John</a> to choose to build their legacy here.',
				youtubeVideoId: "b-AKueR4CrA",
				embedUrl: "https://www.youtube.com/embed/b-AKueR4CrA",
				watchUrl: "https://www.youtube.com/watch?v=b-AKueR4CrA",
				thumbnailUrl: "https://img.youtube.com/vi/b-AKueR4CrA/maxresdefault.jpg",
				duration: null,
				formattedDuration: "",
				publishedAt: "2026-01-15T00:00:00.000Z",
				displayOrder: 3
			}
		]
	};

	// Check if we're running locally
	function isLocalDevelopment(): boolean {
		const hostname = window.location.hostname;
		return hostname === 'localhost' || hostname === '127.0.0.1' || hostname.includes('localhost');
	}

	function createVideoCard(video: Video): HTMLElement {
		const publishedDate = new Date(video.publishedAt).toLocaleDateString('en-US', {
			year: 'numeric',
			month: 'long',
			day: 'numeric'
		});

		const article = document.createElement('article');
		article.className = 'overflow-hidden rounded-xl bg-card shadow-lg dark:shadow-black/20';

		// Create video container with facade pattern (thumbnail + play button)
		// Only loads iframe when user clicks - massive performance improvement on mobile
		const videoContainer = document.createElement('div');
		videoContainer.className = 'aspect-video w-full relative bg-black cursor-pointer group';
		
		// Thumbnail image (uses YouTube's default thumbnail)
		const thumbnail = document.createElement('img');
		thumbnail.src = video.thumbnailUrl;
		thumbnail.alt = video.title;
		thumbnail.className = 'w-full h-full object-cover';
		thumbnail.loading = 'lazy';
		videoContainer.appendChild(thumbnail);
		
		// Play button overlay
		const playButton = document.createElement('div');
		playButton.className = 'absolute inset-0 flex items-center justify-center bg-black/30 group-hover:bg-black/40 transition-colors';
		playButton.innerHTML = `
			<div class="w-16 h-16 md:w-20 md:h-20 bg-red-600 rounded-full flex items-center justify-center shadow-lg group-hover:bg-red-700 group-hover:scale-110 transition-all">
				<svg class="w-8 h-8 md:w-10 md:h-10 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
					<path d="M8 5v14l11-7z"/>
				</svg>
			</div>
		`;
		videoContainer.appendChild(playButton);
		
		// Click handler to load iframe
		videoContainer.addEventListener('click', () => {
			const iframe = document.createElement('iframe');
			// Detect mobile/touch devices - don't autoplay on these
			const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || 
				('ontouchstart' in window) || 
				(navigator.maxTouchPoints > 0);
			iframe.src = video.embedUrl + '?rel=0' + (isMobile ? '' : '&autoplay=1');
			iframe.title = video.title;
			iframe.className = 'absolute inset-0 w-full h-full';
			iframe.frameBorder = '0';
			iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
			iframe.referrerPolicy = 'strict-origin-when-cross-origin';
			iframe.allowFullscreen = true;
			
			// Replace thumbnail with iframe
			videoContainer.innerHTML = '';
			videoContainer.className = 'aspect-video w-full relative';
			videoContainer.appendChild(iframe);
		});
		
		article.appendChild(videoContainer);

		// Create content container
		const contentDiv = document.createElement('div');
		contentDiv.className = 'p-6';

		// Title
		const title = document.createElement('h2');
		title.className = 'text-xl font-semibold text-gray-900 dark:text-gray-100 md:text-2xl';
		title.textContent = video.title;
		contentDiv.appendChild(title);

		// Date and duration
		const dateLine = document.createElement('p');
		dateLine.className = 'mt-1 text-sm text-gray-500 dark:text-gray-400';
		dateLine.textContent = publishedDate;
		if (video.formattedDuration) {
			const separator = document.createElement('span');
			separator.className = 'mx-2';
			separator.textContent = '•';
			dateLine.appendChild(separator);
			dateLine.appendChild(document.createTextNode(video.formattedDuration));
		}
		contentDiv.appendChild(dateLine);

		// Description - use innerHTML to render HTML from API
		const descriptionDiv = document.createElement('div');
		descriptionDiv.className = 'description-content mt-4 text-gray-600 dark:text-gray-300';
		descriptionDiv.innerHTML = video.description;
		// Style links within description
		descriptionDiv.querySelectorAll('a').forEach(link => {
			link.classList.add('text-primary-600', 'underline', 'hover:text-primary-700', 'dark:text-primary-400', 'dark:hover:text-primary-300');
			link.setAttribute('target', '_blank');
			link.setAttribute('rel', 'noopener noreferrer');
		});
		contentDiv.appendChild(descriptionDiv);

		// YouTube link
		const youtubeLink = document.createElement('a');
		youtubeLink.href = video.watchUrl;
		youtubeLink.target = '_blank';
		youtubeLink.rel = 'noopener noreferrer';
		youtubeLink.className = 'mt-4 inline-flex items-center text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300';
		youtubeLink.innerHTML = `
			<svg class="mr-2 h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
				<path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
			</svg>
			Watch on YouTube
		`;
		contentDiv.appendChild(youtubeLink);

		article.appendChild(contentDiv);
		return article;
	}

	function renderVideos(): void {
		const containerEl = document.getElementById('videos-container');
		if (!containerEl) return;

		const startIndex = (currentPage - 1) * VIDEOS_PER_PAGE;
		const endIndex = startIndex + VIDEOS_PER_PAGE;
		const videosToShow = allVideos.slice(startIndex, endIndex);

		// Clear container and append DOM elements
		containerEl.innerHTML = '';
		videosToShow.forEach(video => {
			containerEl.appendChild(createVideoCard(video));
		});
	}

	function updatePagination(): void {
		const paginationEl = document.getElementById('pagination-container');
		const prevBtn = document.getElementById('prev-page') as HTMLButtonElement;
		const nextBtn = document.getElementById('next-page') as HTMLButtonElement;
		const pageInfo = document.getElementById('page-info');

		if (!paginationEl || !prevBtn || !nextBtn || !pageInfo) return;

		const totalPages = Math.ceil(allVideos.length / VIDEOS_PER_PAGE);

		if (totalPages <= 1) {
			paginationEl.classList.add('hidden');
			return;
		}

		paginationEl.classList.remove('hidden');
		pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

		prevBtn.disabled = currentPage === 1;
		nextBtn.disabled = currentPage === totalPages;
	}

	function goToPage(page: number): void {
		currentPage = page;
		renderVideos();
		updatePagination();
		
		// Scroll to top of videos
		const containerEl = document.getElementById('videos-container');
		if (containerEl) {
			containerEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
		}
	}

	async function loadVideos(): Promise<void> {
		const loadingEl = document.getElementById('videos-loading');
		const errorEl = document.getElementById('videos-error');
		const emptyEl = document.getElementById('videos-empty');
		const containerEl = document.getElementById('videos-container');

		loadingEl?.classList.remove('hidden');
		errorEl?.classList.add('hidden');
		emptyEl?.classList.add('hidden');
		containerEl?.classList.add('hidden');

		try {
			let data: VideosApiResponse;
			
			if (isLocalDevelopment()) {
				// Use mock data for local development
				console.log('Using mock data for local development');
				// Simulate network delay
				await new Promise(resolve => setTimeout(resolve, 500));
				data = mockData;
			} else {
				// Fetch from API in production
				const response = await fetch(`https://ai.seattlefoundations.org/api/almost-live/videos?t=${Date.now()}`, {
					method: 'GET',
					headers: { 'Accept': 'application/json' }
				});
				if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
				data = await response.json();
			}

			loadingEl?.classList.add('hidden');

			allVideos = data.success && data.videos ? data.videos : [];
			
			// Sort by displayOrder
			allVideos.sort((a, b) => a.displayOrder - b.displayOrder);

			if (!allVideos.length) {
				emptyEl?.classList.remove('hidden');
				return;
			}

			containerEl?.classList.remove('hidden');
			currentPage = 1;
			renderVideos();
			updatePagination();
		} catch (e) {
			console.error('Error fetching videos:', e);
			loadingEl?.classList.add('hidden');
			errorEl?.classList.remove('hidden');
		}
	}

	function bindPaginationEvents(): void {
		const prevBtn = document.getElementById('prev-page');
		const nextBtn = document.getElementById('next-page');

		prevBtn?.addEventListener('click', () => {
			if (currentPage > 1) {
				goToPage(currentPage - 1);
			}
		});

		nextBtn?.addEventListener('click', () => {
			const totalPages = Math.ceil(allVideos.length / VIDEOS_PER_PAGE);
			if (currentPage < totalPages) {
				goToPage(currentPage + 1);
			}
		});
	}

	let videosLoaded = false;
	function checkAndLoadVideos() {
		const isAlmostLivePage = window.location.pathname === '/almost-live' || window.location.pathname === '/almost-live/';
		const hasContainer = document.getElementById('videos-container') !== null;
		if (isAlmostLivePage && hasContainer && !videosLoaded) {
			videosLoaded = true;
			loadVideos();
		} else if (!isAlmostLivePage) {
			videosLoaded = false;
		}
	}

	document.addEventListener('DOMContentLoaded', () => {
		bindPaginationEvents();
		checkAndLoadVideos();
	});

	checkAndLoadVideos();

	const observer = new MutationObserver(() => { checkAndLoadVideos(); });
	observer.observe(document.body, { childList: true, subtree: true });

	document.addEventListener('visibilitychange', () => {
		if (!document.hidden && (window.location.pathname === '/almost-live' || window.location.pathname === '/almost-live/')) {
			videosLoaded = false;
			checkAndLoadVideos();
		}
	});

	document.addEventListener('astro:page-load', () => {
		bindPaginationEvents();
		checkAndLoadVideos();
	});

	document.addEventListener('astro:after-swap', () => {
		bindPaginationEvents();
		videosLoaded = false;
		checkAndLoadVideos();
	});
</script>
