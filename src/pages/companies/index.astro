---
// layout
import BaseLayout from "@layouts/BaseLayout.astro";

export const prerender = false;
---

<BaseLayout
	title="Companies - Foundations"
	description="Foundations Founder in Residence Companies"
>
	<section class="site-container space-y-12">
		<div
			class="overflow-x-clip bg-[url('/assets/pattern-light.svg')] bg-center bg-no-repeat pt-24 md:pt-32 dark:bg-none"
		>
			<div class="mx-auto flex max-w-[950px] flex-col justify-center">
				<h1 class="h1 text-center">Companies</h1>
			</div>
		</div>

		<!-- Loading state -->
		<div id="companies-loading" class="mx-auto max-w-2xl text-center">
			<div class="rounded-lg bg-gray-50 p-8 dark:bg-gray-800/50">
				<div class="mx-auto mb-4 h-12 w-12 animate-spin rounded-full border-4 border-gray-300 border-t-primary-600"></div>
				<p class="text-lg text-gray-600 dark:text-gray-300">Loading companies...</p>
			</div>
		</div>

		<!-- Error state (hidden by default) -->
		<div id="companies-error" class="mx-auto max-w-2xl text-center hidden">
			<div class="rounded-lg bg-red-50 p-8 dark:bg-red-900/20">
				<p class="text-lg text-red-800 dark:text-red-300">Failed to load companies</p>
				<p class="mt-2 text-sm text-red-600 dark:text-red-400">Please try again later.</p>
			</div>
		</div>

		<!-- Empty state (hidden by default) -->
		<div id="companies-empty" class="mx-auto max-w-2xl text-center hidden">
			<div class="rounded-lg bg-gray-50 p-8 dark:bg-gray-800/50">
				<p class="text-lg text-gray-600 dark:text-gray-300">No companies to display.</p>
			</div>
		</div>

		<!-- Companies container (hidden by default) -->
		<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
			<div id="companies-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 hidden"></div>
		</div>
	</section>
</BaseLayout>

<script>
	interface CompanyMember { name: string; linkedin?: string }
	interface Company {
		id: string;
		slug: string;
		name: string;
		url?: string | null;
		description?: string | null;
		logo?: string | null;
		memberCount?: number;
		alumn?: boolean | null;
		fir?: boolean | null;
		members?: CompanyMember[];
	}

	interface CompaniesApiResponse {
		success: boolean;
		data?: { companies?: Company[] };
	}

	function companyLogoUrl(relativeUrl: string): string {
		return new URL(relativeUrl, 'https://ai.seattlefoundations.org').toString();
	}

	function getPriority(company: Company): number {
		if (company.fir && !company.alumn) return 1; // Active FIR
		if (company.fir && company.alumn) return 2;  // FIR Alumni
		return 3; // Members
	}

	function createCompanyCard(company: Company): string {
		return `
			<a href="/companies/${company.slug}" class="group">
				<div class="flex flex-col items-center border-r border-b border-gray-200 p-4 transition-all duration-200 hover:shadow-lg">
					<div class="flex h-20 w-full items-center justify-center px-8">
						${company.logo ? `
							<img src="${companyLogoUrl(company.logo)}" alt="${company.name} logo" class="h-16 object-contain" />
						` : `
							<div class="flex h-16 w-16 items-center justify-center rounded-full bg-gray-100">
								<span class="text-lg font-medium text-gray-500">${company.name.charAt(0)}</span>
							</div>
						`}
					</div>
					<h3 class="group-hover:text-primary-600 mt-2 text-center text-sm text-gray-900">
						<span class="flex items-center justify-center text-base">${company.name}</span>
						<div class="mt-1 flex items-center justify-center gap-1">
							${company.alumn ? `
								<span class="bg-primary-500/40 text-primary-800 inline-flex items-center rounded-full px-2 py-1 text-xs font-medium">Alum</span>
							` : ''}
							${company.fir ? `
								<span class="bg-gray-500/40 text-gray-800 inline-flex items-center rounded-full px-2 py-1 text-xs font-medium">Founder in Residence</span>
							` : `
								<span class="bg-green-500/40 text-green-800 inline-flex items-center rounded-full px-2 py-1 text-xs font-medium">Member</span>
							`}
						</div>
					</h3>
				</div>
			</a>
		`;
	}

	async function loadCompanies(): Promise<void> {
		const loadingEl = document.getElementById('companies-loading');
		const errorEl = document.getElementById('companies-error');
		const emptyEl = document.getElementById('companies-empty');
		const containerEl = document.getElementById('companies-container');

		loadingEl?.classList.remove('hidden');
		errorEl?.classList.add('hidden');
		emptyEl?.classList.add('hidden');
		containerEl?.classList.add('hidden');

		try {
			const response = await fetch(`https://ai.seattlefoundations.org/api/companies?t=${Date.now()}`, {
				method: 'GET',
				headers: { 'Accept': 'application/json' }
			});
			if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
			const data: CompaniesApiResponse = await response.json();

			loadingEl?.classList.add('hidden');

			const companies = data.success && data.data && data.data.companies ? data.data.companies : [];

			if (!companies.length) {
				emptyEl?.classList.remove('hidden');
				return;
			}

			const sorted = companies.sort((a, b) => {
				const pa = getPriority(a);
				const pb = getPriority(b);
				if (pa !== pb) return pa - pb;
				return a.name.localeCompare(b.name);
			});

			const html = sorted.map(c => createCompanyCard(c)).join('');
			if (containerEl) {
				containerEl.innerHTML = html;
				containerEl.classList.remove('hidden');
			}
		} catch (e) {
			console.error('Error fetching companies:', e);
			loadingEl?.classList.add('hidden');
			errorEl?.classList.remove('hidden');
		}
	}

	let companiesLoaded = false;
	function checkAndLoadCompanies() {
		const isCompaniesPage = window.location.pathname === '/companies' || window.location.pathname === '/companies/';
		const hasContainer = document.getElementById('companies-container') !== null;
		if (isCompaniesPage && hasContainer && !companiesLoaded) {
			companiesLoaded = true;
			loadCompanies();
		} else if (!isCompaniesPage) {
			companiesLoaded = false;
		}
	}

	checkAndLoadCompanies();

	const observer = new MutationObserver(() => { checkAndLoadCompanies(); });
	observer.observe(document.body, { childList: true, subtree: true });

	document.addEventListener('visibilitychange', () => {
		if (!document.hidden && (window.location.pathname === '/companies' || window.location.pathname === '/companies/')) {
			companiesLoaded = false;
			checkAndLoadCompanies();
		}
	});

	window.addEventListener('popstate', () => {
		companiesLoaded = false;
		setTimeout(checkAndLoadCompanies, 100);
	});

	document.addEventListener('astro:after-swap', () => {
		companiesLoaded = false;
		checkAndLoadCompanies();
	});
</script>
